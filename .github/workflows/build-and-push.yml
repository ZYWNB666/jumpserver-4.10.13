name: Build and Push JumpServer Image

on:
  push:
    branches:
      - main
      - master
      - dev
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_suffix:
        description: 'Custom tag suffix (optional)'
        required: false
        default: ''
        type: string

jobs:
  build-and-push:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-shanghai.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Generate image tag
        id: meta
        run: |
          # åŸºç¡€ç‰ˆæœ¬å·ï¼ˆåŸºäºŽ JumpServer ç‰ˆæœ¬ï¼‰
          BASE_VERSION="v4.10.13"
          
          # ç”Ÿæˆæ—¶é—´æˆ³: 202512052106
          TIMESTAMP=$(date +'%Y%m%d%H%M')
          
          # ç”ŸæˆçŸ­ commit hash
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          
          # ç‰ˆæœ¬å·ç­–ç•¥ï¼š
          # 1. å¦‚æžœæ˜¯ tag æŽ¨é€ï¼Œä½¿ç”¨ tag åç§°
          # 2. å¦åˆ™ä½¿ç”¨: v4.10.13-202512052106-abc1234
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # æå– tag åç§°ï¼ˆåŽ»æŽ‰ refs/tags/ å‰ç¼€ï¼‰
            VERSION="${{ github.ref_name }}"
          else
            # ç»„åˆç‰ˆæœ¬å·ï¼šåŸºç¡€ç‰ˆæœ¬-æ—¶é—´æˆ³-commit
            VERSION="${BASE_VERSION}-${TIMESTAMP}-${COMMIT_SHORT}"
          fi
          
          # å¦‚æžœæœ‰è‡ªå®šä¹‰åŽç¼€ï¼Œæ·»åŠ åˆ°ç‰ˆæœ¬å·
          if [ -n "${{ inputs.tag_suffix }}" ]; then
            VERSION="${VERSION}-${{ inputs.tag_suffix }}"
          fi
          
          # è®¾ç½®å®Œæ•´é•œåƒåç§°
          FULL_IMAGE="registry.cn-shanghai.aliyuncs.com/zywdockers/jmp-core:${VERSION}"
          LATEST_IMAGE="registry.cn-shanghai.aliyuncs.com/zywdockers/jmp-core:latest"
          
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "FULL_IMAGE=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          echo "LATEST_IMAGE=${LATEST_IMAGE}" >> $GITHUB_OUTPUT
          
          echo "::notice::Building image: ${FULL_IMAGE}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ steps.meta.outputs.FULL_IMAGE }}
            ${{ steps.meta.outputs.LATEST_IMAGE }}
          # é˜¿é‡Œäº‘ä¸æ”¯æŒ BuildKit cacheï¼Œæ”¹ç”¨ inline cache
          cache-from: type=registry,ref=${{ steps.meta.outputs.LATEST_IMAGE }}
          cache-to: type=inline
          build-args: |
            VERSION=${{ steps.meta.outputs.VERSION }}
            BUILDKIT_INLINE_CACHE=1

      - name: Build summary
        run: |
          echo "## Build Success! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.meta.outputs.VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.meta.outputs.FULL_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Latest:** \`${{ steps.meta.outputs.LATEST_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull specific version" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ steps.meta.outputs.FULL_IMAGE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Pull latest" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ steps.meta.outputs.LATEST_IMAGE }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

