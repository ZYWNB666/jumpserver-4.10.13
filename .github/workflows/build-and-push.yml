name: Build and Push JumpServer Image

on:
  push:
    branches:
      - main
      - master
      - dev
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_suffix:
        description: 'Custom tag suffix (optional)'
        required: false
        default: ''
        type: string

jobs:
  build-and-push:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: registry.cn-shanghai.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Generate image tag
        id: meta
        run: |
          # ç”Ÿæˆæ—¶é—´æˆ³æ ‡ç­¾: jmp-core-202512052106
          TIMESTAMP=$(date +'%Y%m%d%H%M')
          IMAGE_TAG="jmp-core-${TIMESTAMP}"
          
          # å¦‚æžœæœ‰è‡ªå®šä¹‰åŽç¼€ï¼Œæ·»åŠ åˆ°æ ‡ç­¾
          if [ -n "${{ inputs.tag_suffix }}" ]; then
            IMAGE_TAG="${IMAGE_TAG}-${{ inputs.tag_suffix }}"
          fi
          
          # è®¾ç½®å®Œæ•´é•œåƒåç§°
          FULL_IMAGE="registry.cn-shanghai.aliyuncs.com/zywdockers/images:${IMAGE_TAG}"
          
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "FULL_IMAGE=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          
          echo "::notice::Building image: ${FULL_IMAGE}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ steps.meta.outputs.FULL_IMAGE }}
            registry.cn-shanghai.aliyuncs.com/zywdockers/images:jmp-core-latest
          # é˜¿é‡Œäº‘ä¸æ”¯æŒ BuildKit cacheï¼Œæ”¹ç”¨ inline cache
          cache-from: type=registry,ref=registry.cn-shanghai.aliyuncs.com/zywdockers/images:jmp-core-latest
          cache-to: type=inline
          build-args: |
            VERSION=${{ github.ref_name }}
            BUILDKIT_INLINE_CACHE=1

      - name: Build summary
        run: |
          echo "## Build Success! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.meta.outputs.FULL_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Latest:** \`registry.cn-shanghai.aliyuncs.com/zywdockers/images:jmp-core-latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ steps.meta.outputs.FULL_IMAGE }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

